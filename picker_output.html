<html>
<meta charset=utf-8>
<button id="go">Go!</button><br><br>
<fieldset id="panel" disabled>
  Speakers: <button id="speakers">Default system output...</button> <button id="reset" hidden>Reset</button>
<br>
</fieldset><br>
<video id="video" height="200" src="frag_bunny.mp4" controls></video><br>
<div id="div"></div><br>
<script>

const console = { log: msg => div.innerHTML += msg + "<br>" };
const wait = ms => new Promise(resolve => setTimeout(resolve, ms));

async function selectAudioOutput(options) {
  const info = await navigator.mediaDevices.selectAudioOutput(options);
  localStorage.speakers = info.deviceId;
  localStorage.speakersLabel = info.label;
  return info;
}

async function setSinkId({deviceId, label = "Default system output"}) {
  if (deviceId == video.sinkId) return;
  console.log(`Switching output to ${label}`);
  await video.setSinkId(deviceId);
  speakers.innerText = `${label}...`;
  reset.hidden = !deviceId.length;
}

go.onclick = async () => {
  try {
    if (localStorage.speakers) {
      await setSinkId(await selectAudioOutput({deviceId: localStorage.speakers}));
    }
    panel.disabled = false;
    await video.play();
  } catch (e) {
    console.log(e);
  }
};

speakers.onclick = async () => {
  try {
    await setSinkId(await selectAudioOutput());
  } catch (e) {
    console.log(e);
  }
};

reset.onclick = async () => {
  try {
    await setSinkId({deviceId: ""});
  } catch (e) {
    console.log(e);
  }
};

navigator.mediaDevices.ondevicechange = async () => {
  try {
    const devices = await navigator.mediaDevices.enumerateDevices();
    if (!devices.find(({deviceId}) => deviceId == video.sinkId)) {
      reset.onclick();
    }
  } catch (e) {
    console.log(e);
  }
}

</script>
</html>
