<html>
<meta charset=utf-8>
<button id="go">Go!</button><br><br>
<fieldset id="panel" disabled>
  Speakers: <button id="speakers">Default system output...</button> <button id="reset" hidden>Reset</button>
<br>
</fieldset><br>
<video id="video" height="200" src="frag_bunny.mp4" controls></video><br>
<div id="div"></div><br>
<script>

const console = { log: msg => div.innerHTML += msg + "<br>" };
const wait = ms => new Promise(resolve => setTimeout(resolve, ms));

async function selectAudioOutput(options) {
  const info = await navigator.mediaDevices.selectAudioOutput(options);
  localStorage.speakers = info.deviceId;
  localStorage.speakersLabel = info.label;
  return info;
}

go.onclick = async () => {
  try {
    if (localStorage.speakers) {
      try {
        const {deviceId, label} = await selectAudioOutput({deviceId: localStorage.speakers});
        await video.setSinkId(deviceId);
        speakers.innerText = `${label}...`;
        reset.hidden = false;
      } catch (e) {
        console.log(e);
      }
    }
    panel.disabled = false;
    await video.play();
  } catch (e) {
    console.log(e);
  }
};

speakers.onclick = async () => {
  try {
    const {deviceId, label} = await selectAudioOutput();
    console.log(`Switching output to ${label}`);
    await video.setSinkId(deviceId);
    speakers.innerText = `${label}...`;
    reset.hidden = false;
  } catch (e) {
    console.log(e);
  }
};

reset.onclick = async () => {
  try {
    await video.setSinkId("");
    speakers.innerText = "Default system output...";
    reset.hidden = true;
  } catch (e) {
    console.log(e);
  }
};

navigator.mediaDevices.ondevicechange = async () => {
  try {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const device = devices.find(({deviceId}) => deviceId == video.sinkId);
    if (!device) {
      await reset.onclick();
    }
  } catch (e) {
    console.log(e);
  }
}

</script>
</html>
